ì§€ê¸ˆê¹Œì§€ ë…¼ì˜ëœ ëª¨ë“  ë‚´ìš©(ì´ˆê¸° ì„¤ê³„ë¶€í„° Claude/Geminiì˜ ê²€í† ì‚¬í•­, PDF íŒŒì„œ êµì²´, ìˆ˜ì • ì£¼ê°€ ë¡œì§, ëª¨ë©˜í…€/ê³¼ì—´ íƒì§€ ë“±)ì„ ì™„ë²½í•˜ê²Œ í†µí•©í•œ **ìµœì¢… ì„¤ê³„ì„œ(Final Ultimate Version)**ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

ë¬¸ì„œê°€ ë°©ëŒ€í•˜ë¯€ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤. ì™„ë£Œë  ë•Œê¹Œì§€ `continue`ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.

---

# ğŸ“Š íˆ¬ì ì¸í…”ë¦¬ì „ìŠ¤ ì‹œìŠ¤í…œ: ì¦ê¶Œì‚¬ ë¦¬í¬íŠ¸ ë¶„ì„ ì„¤ê³„ì„œ (Final Ultimate Ver.)

> **ë¬¸ì„œ ëª©ì **: ì¦ê¶Œì‚¬ ë¦¬í¬íŠ¸(PDF) ë° ìœ íŠœë¸Œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹œì¥ì˜ ì™œê³¡ëœ ì‹ í˜¸ë¥¼ êµì •í•˜ê³ , 'ë¹„ê´€ì˜ ë(ì €ì )'ê³¼ 'ì‹œì¥ ê³¼ì—´(ê³ ì )'ì„ íŒë³„í•˜ë©°, ì• ë„ë¦¬ìŠ¤íŠ¸ ì‹ ë¢°ë„ë¥¼ ì¶”ì í•˜ì—¬ ì‹¬ì¸µ íˆ¬ì ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ê°œì¸ìš© ì•ŒíŒŒ(Alpha) ìƒì„± ì‹œìŠ¤í…œ êµ¬ì¶•.

---

## 1. ì„¤ê³„ ê°œìš” ë° ì „ëµì  ëª©í‘œ

### 1.1 í•µì‹¬ ì„¤ê³„ ì›ì¹™
ë³¸ ì‹œìŠ¤í…œì€ ë‹¨ìˆœí•œ ì •ë³´ ìš”ì•½ì„ ë„˜ì–´, ë°ì´í„°ì˜ **'ì§„ìœ„ ì—¬ë¶€ ê²€ì¦'**ê³¼ **'ì‹œì¥ ì‚¬ì´í´ í¬ì°©'**ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.

1.  **Signal over Opinion (ì‹ í˜¸ ì¤‘ì‹¬)**: í•œêµ­ ì‹œì¥ì˜ êµ¬ì¡°ì  í¸í–¥(ë§¤ìˆ˜ ì˜ê²¬ ê³¼ì‰)ì„ ê³ ë ¤í•˜ì—¬, 'ëª©í‘œê°€ í•˜í–¥'ê³¼ 'ì˜ê²¬ ë³€ê²½'ì„ í•µì‹¬ ì‹ í˜¸ë¡œ í•´ì„í•©ë‹ˆë‹¤.
2.  **Data Integrity (ë°ì´í„° ì •í•©ì„±)**: ì•¡ë©´ë¶„í• /ì¦ìë¡œ ì¸í•œ ëª©í‘œê°€ ì™œê³¡ì„ ë°©ì§€í•˜ëŠ” 'ìˆ˜ì • ì£¼ê°€ ë¡œì§'ì„ ì ìš©í•˜ê³ , ì‹œê°„ ì—­ìˆœ ìˆ˜ì§‘ì—ë„ ì•ˆì „í•œ ì´ë ¥ ê´€ë¦¬ ì²´ê³„ë¥¼ ê°–ì¶¥ë‹ˆë‹¤.
3.  **Strategic Duality (ì „ëµì  ì´ì¤‘ì„±)**: ì¼„ í”¼ì…” ìŠ¤íƒ€ì¼ì˜ 'ì—­ë°œìƒ(ë¹„ê´€ì˜ ë)'ê³¼ ë“œëŸ¬ì¼„ë°€ëŸ¬ ìŠ¤íƒ€ì¼ì˜ 'ëª¨ë©˜í…€(ê°€ì†ë„)'ì„ ë™ì‹œì— íƒì§€í•©ë‹ˆë‹¤.
4.  **Cost Efficiency (ê²½ì œì  íš¨ìœ¨ì„±)**: Gemini Flash(ì €ë¹„ìš© ì¶”ì¶œ)ì™€ Claude Sonnet(ê³ í’ˆì§ˆ ë¶„ì„)ì˜ ì—­í•  ë¶„ë¦¬, ë¡œì»¬ ë¦¬ì†ŒìŠ¤(Mac) í™œìš©ì„ í†µí•´ ìš´ì˜ ë¹„ìš©ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.

### 1.2 íˆ¬ì ì² í•™ êµ¬í˜„ (Use Cases)
-   **Contrarian (ë§¤ìˆ˜ íƒ€ì´ë°)**: ì• ë„ë¦¬ìŠ¤íŠ¸ë“¤ì˜ ê·¹ë„ì˜ ë¹„ê´€(+ ëª©í‘œê°€ ëŒ€í­ í•˜í–¥)ì´ ê°ì§€ë  ë•Œ, ê³¼ê±° íŒ¨í„´ê³¼ ë¹„êµí•˜ì—¬ ì €ì  ê°€ëŠ¥ì„± íƒì§€.
-   **Momentum (ì¶”ì„¸ ì¶”ì¢…)**: ëª©í‘œê°€ ìƒí–¥ ì†ë„(Velocity)ê°€ ë¹¨ë¼ì§€ê³  ì»¨ì„¼ì„œìŠ¤ê°€ ì¢í˜€ì§ˆ ë•Œ, ì¶”ì„¸ì˜ ê°•ë„ í™•ì¸.
-   **Risk Aversion (ë§¤ë„/íšŒí”¼ íƒ€ì´ë°)**: ëª©í‘œê°€ ìƒìŠ¹ ì—¬ë ¥ì´ ì†Œì§„ë˜ê³  ëª¨ë“  ì˜ê²¬ì´ 'ë§¤ìˆ˜'ë¡œ ì¼ì¹˜í•  ë•Œ, ê³¼ì—´(Euphoria) êµ­ë©´ ê²½ê³ .
-   **Value Trap íšŒí”¼**: ì €í‰ê°€ ì¢…ëª© ì¤‘ í€ë”ë©˜í„¸ì´ 'êµ¬ì¡°ì  ì‡ í‡´'ì¸ ì¢…ëª©ì„ ìë™ í•„í„°ë§.

### 1.3 ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ (Architecture)

```mermaid
flowchart TD
    subgraph Sources ["ë°ì´í„° ì†ŒìŠ¤ (Extensible)"]
        A1["Naver Finance (êµ­ë‚´)"]
        A2["Telegram/Discord (ì™¸êµ­ê³„)"]
        A3["Stock Price API (ìˆ˜ì • ì£¼ê°€)"]
    end

    subgraph Ingestion ["ìˆ˜ì§‘ ë ˆì´ì–´ (Ingestion)"]
        B1["PDF Downloader (Playwright)"]
        B2["Price Collector (Adjusted)"]
        B3["Deduplication (Hash)"]
    end

    subgraph Processing ["ì²˜ë¦¬ ë ˆì´ì–´ (Pipeline)"]
        C1["Structure-Aware Parser\n(Upstage/MinerU)"]
        C2["Quality Check"]
        C3["OCR Fallback (PaddleOCR)"]
        C4["Text Preprocessor\n(Rule-based Correction)"]
        C5["Metadata Injector"]
    end

    subgraph Intelligence ["ì§€ëŠ¥ ë ˆì´ì–´ (LLM & Analytics)"]
        D1["Analyst Identifier\n(Time-Resistant)"]
        D2["Target Price Resolver\n(Adjustment Logic)"]
        D3["LLM Router"]
        D3_1["Gemini Flash\n(Extraction + Correction)"]
        D3_2["Claude Sonnet\n(Deep Reasoning)"]
        D4["Embedding Generator\n(BGE-M3/text-embedding-3)"]
        D5["Sentiment Aggregator\n(KR Market Logic)"]
    end

    subgraph DeepResearch ["ë”¥ ë¦¬ì„œì¹˜ ì—”ì§„"]
        E1["Regime Detector\n(Pessimism/Euphoria)"]
        E2["Pattern Matcher (pgvector)"]
        E3["Insight Generator"]
    end

    subgraph Storage ["ì €ì¥ì†Œ (Storage)"]
        F1[("PostgreSQL\n(Metadata + pgvector)")]
        F2[("Local/Object Storage\n(PDF & Temp Files)")]
    end

    A1 & A2 --> B1 --> B3 --> C1 --> C2
    C2 -- "Low Quality" --> C3 --> C4
    C2 -- "OK" --> C4 --> C5
    
    A3 --> B2 --> F1
    
    C5 --> D1 & D2 --> D3
    D3 --> D3_1 --> F1
    F1 --> D4 --> F1
    D3_1 --> D5 --> F1
    
    F1 --> E1 --> E2 --> E3 --> D3_2
    
    B1 --> F2
```

---

## 2. PDF ì²˜ë¦¬ ë° í…ìŠ¤íŠ¸ ì •ì œ íŒŒì´í”„ë¼ì¸ (Advanced Pipeline)

ì¦ê¶Œì‚¬ ë¦¬í¬íŠ¸ì˜ ë³µì¡í•œ ë ˆì´ì•„ì›ƒê³¼ í…ìŠ¤íŠ¸ ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ê³ ë„í™”ëœ ì „ì²˜ë¦¬ ê³¼ì •ì…ë‹ˆë‹¤.

### 2.1 ë¬¸ì„œ êµ¬ì¡° ì¸ì‹ íŒŒì„œ (Structure-Aware Parser)
ê¸°ì¡´ `pdfplumber`ëŠ” ë‹¤ë‹¨ ë ˆì´ì•„ì›ƒì—ì„œ í…ìŠ¤íŠ¸ ìˆœì„œê°€ ë’¤ì„ì´ëŠ” ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **ì‹œê°ì  êµ¬ì¡°ë¥¼ ì´í•´í•˜ëŠ” íŒŒì„œ**ë¥¼ ë„ì…í•©ë‹ˆë‹¤.

-   **1ìˆœìœ„ (API)**: **Upstage Document Parse** (í•œêµ­ì–´ ì„œë¥˜ íŠ¹í™”, í‘œ ì¸ì‹ ìš°ìˆ˜).
-   **2ìˆœìœ„ (Local)**: **MinerU (Magic-PDF)** (ì˜¤í”ˆì†ŒìŠ¤, PDFë¥¼ Markdownìœ¼ë¡œ ë³€í™˜, ë¡œì»¬ ì‹¤í–‰ ê°€ëŠ¥).
-   **3ìˆœìœ„ (Fallback)**: `pdfplumber` + `PaddleOCR` (í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì—†ëŠ” ìŠ¤ìº”ë³¸ ëŒ€ì‘).

### 2.2 í…ìŠ¤íŠ¸ í’ˆì§ˆ ê²€ì¦ ë° êµì • (Correction Strategy)
ë¹„ìš© íš¨ìœ¨ì„±ì„ ìœ„í•´ Rule-basedì™€ LLMì„ í˜¼í•©í•œ í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

**Step 1: Rule-based ì‚¬ì „ êµì • (Cost: $0)**
ìœ íŠœë¸Œ ìë§‰ ë° OCR ì˜¤ë¥˜ ì¤‘ ë¹ˆë„ê°€ ë†’ì€ íŒ¨í„´ì„ ì •ê·œì‹ìœ¼ë¡œ ì¹˜í™˜í•©ë‹ˆë‹¤.
```python
CORRECTION_DICT = {
    r"ì—ì¹˜ë¹„ì— ": "HBM",
    r"ì—”ë¹„ë””ì•¼": "NVIDIA",
    r"ì‚¼ì „": "ì‚¼ì„±ì „ì",
    r"í‹°ì—ìŠ¤ì— ì”¨": "TSMC",
    # ê¸ˆìœµ/IT ë„ë©”ì¸ íŠ¹í™” ë‹¨ì–´ ì‚¬ì „ ìœ ì§€
}

def preprocess_text(text: str) -> str:
    for pattern, replacement in CORRECTION_DICT.items():
        text = re.sub(pattern, replacement, text)
    return text
```

**Step 2: LLM í”„ë¡¬í”„íŠ¸ í†µí•© êµì •**
ë³„ë„ì˜ API í˜¸ì¶œ ì—†ì´ ì¶”ì¶œ ë‹¨ê³„ì—ì„œ êµì •ì„ ì§€ì‹œí•˜ì—¬ ë¹„ìš©ì„ ì ˆê°í•©ë‹ˆë‹¤.
```python
EXTRACTION_PROMPT = """
PDF í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ JSONì„ ìƒì„±í•˜ë¼.
ì£¼ì˜: ìŒì„± ì¸ì‹ ì˜¤ë¥˜ë‚˜ ì˜¤íƒ€ë¡œ ë³´ì´ëŠ” ê³ ìœ ëª…ì‚¬(ì˜ˆ: 'ì—ì¹˜ë¹„ì— ')ëŠ” ë¬¸ë§¥ì„ ê³ ë ¤í•˜ì—¬ 
ì˜¬ë°”ë¥¸ ê¸ˆìœµ ìš©ì–´('HBM')ë¡œ êµì •í•˜ì—¬ ì¶œë ¥í•˜ë¼.
...
"""
```

### 2.3 ë©”íƒ€ë°ì´í„° ì£¼ì… (Vector Search Optimization)
RAG ê²€ìƒ‰ ì‹œ "ì´ íšŒì‚¬" ë“± ëŒ€ëª…ì‚¬ ì‚¬ìš©ìœ¼ë¡œ ì¸í•œ ê²€ìƒ‰ ëˆ„ë½(False Negative)ì„ ë°©ì§€í•˜ê¸° ìœ„í•´, ì²­í‚¹ ì‹œ ë©”íƒ€ë°ì´í„°ë¥¼ ê°•ì œë¡œ ë¶€ì°©í•©ë‹ˆë‹¤.
```python
def create_chunk_with_metadata(text: str, report_meta: dict) -> str:
    # ì˜ˆ: "[ì¢…ëª©: ì‚¼ì„±ì „ì] [ë‚ ì§œ: 2024-10-25] ë³¸ë¬¸ í…ìŠ¤íŠ¸..."
    prefix = f"[ì¢…ëª©: {report_meta['asset_name']}] [ë‚ ì§œ: {report_meta['date']}] "
    return prefix + text
```

## 3. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ (Database Schema v7)

íˆ¬ì ì „ëµì˜ ì´ì›í™”(ì €ì  íƒì§€/ê³ ì  íƒì§€)ì™€ ë°ì´í„° ì‹ ë¢°ì„± í™•ë³´(ìˆ˜ì • ì£¼ê°€)ë¥¼ ìœ„í•œ ìµœì¢… ìŠ¤í‚¤ë§ˆì…ë‹ˆë‹¤.

### 3.1 ERD (Entity Relationship Diagram)

```mermaid
erDiagram
    PERSONS ||--o{ ANALYST_HISTORIES : "has_career"
    PERSONS ||--o{ REPORT_ANALYSTS : "authors"
    PERSONS ||--o{ PREDICTION_OUTCOMES : "predicted"
    
    REPORTS ||--o{ REPORT_ANALYSTS : "written_by"
    REPORTS ||--|| REPORT_FILES : "has_file"
    REPORTS ||--o{ REPORT_OPINIONS : "analyzed_to"
    REPORTS ||--o{ REPORT_EMBEDDINGS : "vectorized_to"
    
    ASSETS_MASTER ||--o{ REPORT_OPINIONS : "target_of"
    ASSETS_MASTER ||--o{ STOCK_PRICES : "has_prices"
    ASSETS_MASTER ||--o{ ASSET_SENTIMENT_DAILY : "has_sentiment"
    ASSETS_MASTER ||--o{ PESSIMISM_PERIODS : "has_pessimism"
    ASSETS_MASTER ||--o{ EUPHORIA_PERIODS : "has_euphoria"

    TRACKING_TARGETS ||--o{ ASSETS_MASTER : "tracks"

    PERSONS {
        uuid id PK
        string name
        float reliability_30d
        float reliability_365d
        jsonb sector_expertise
    }
    
    REPORT_OPINIONS {
        uuid id PK
        float target_price
        float prev_target_price
        float tp_change_pct
        jsonb key_theses
        enum fundamental_status
    }
    
    STOCK_PRICES {
        uuid asset_id FK
        date date
        float close_price
        float adjustment_factor
    }
    
    ASSET_SENTIMENT_DAILY {
        uuid asset_id FK
        date date
        float sentiment_score
        int bearish_count
        float tp_up_velocity
        float min_upside_pct
    }
    
    PESSIMISM_PERIODS {
        uuid id PK
        boolean was_actual_bottom
        float return_1y
    }
    
    EUPHORIA_PERIODS {
        uuid id PK
        boolean was_actual_top
        float price_drop_3m
    }
```

### 3.2 SQL DDL (PostgreSQL)

```sql
-- ==========================================
-- 0. í™•ì¥ ê¸°ëŠ¥ ë° ENUM (Types)
-- ==========================================
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgvector";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- ì˜ê²¬ ìœ í˜•
CREATE TYPE opinion_type AS ENUM ('STRONG_BUY', 'BUY', 'HOLD', 'SELL', 'STRONG_SELL');
-- í€ë”ë©˜í„¸ ìƒíƒœ (ê°€ì¹˜ í•¨ì • íƒì§€ìš©)
CREATE TYPE fundamental_status AS ENUM (
    'CYCLICAL_DOWNTURN', -- ìˆœí™˜ì  ì¹¨ì²´ (ë§¤ìˆ˜ ê¸°íšŒ)
    'STRUCTURAL_DECLINE',-- êµ¬ì¡°ì  ì‡ í‡´ (ê°€ì¹˜ í•¨ì • - ì œì™¸)
    'GROWTH',            -- ì„±ì¥
    'TURNAROUND'         -- í„´ì–´ë¼ìš´ë“œ
);
-- ì²˜ë¦¬ ìƒíƒœ
CREATE TYPE processing_status AS ENUM (
    'collected', 'downloaded', 'text_extracted', 
    'llm_processed', 'completed', 
    'failed_download', 'failed_extraction', 'failed_llm',
    'validation_failed', 'skipped'
);

-- ==========================================
-- 1. ë§ˆìŠ¤í„° ë° ìš´ì˜ í…Œì´ë¸”
-- ==========================================

-- ì¢…ëª© (Asset)
CREATE TABLE assets_master (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    ticker VARCHAR(20) UNIQUE,
    name VARCHAR(100) NOT NULL,
    market VARCHAR(20),
    sector VARCHAR(100),
    aliases JSONB DEFAULT '[]',
    created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_assets_aliases ON assets_master USING gin(aliases);

-- ë°ì´í„° ìˆ˜ì§‘ íƒ€ê²Ÿ ê´€ë¦¬ (ë°±í•„ ë° íŠ¸ë˜í‚¹ìš©)
CREATE TABLE tracking_targets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    target_type VARCHAR(20),   -- 'ASSET', 'SECTOR'
    target_name VARCHAR(100),
    backfill_years INTEGER,    -- ìˆ˜ì§‘ ê¸°ê°„ (ì˜ˆ: 5ë…„, 10ë…„)
    is_active BOOLEAN DEFAULT TRUE,
    last_collected_at TIMESTAMP
);

-- ì• ë„ë¦¬ìŠ¤íŠ¸ (Person)
CREATE TABLE persons (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(50) NOT NULL,
    current_firm_id UUID REFERENCES securities_firms(id),
    
    -- ë‹¤ì¤‘ Horizon ì‹ ë¢°ë„
    reliability_30d FLOAT DEFAULT 50.0,
    reliability_90d FLOAT DEFAULT 50.0,
    reliability_365d FLOAT DEFAULT 50.0,
    sample_count INTEGER DEFAULT 0,
    sector_expertise JSONB DEFAULT '{}',
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- ì• ë„ë¦¬ìŠ¤íŠ¸ ì´ë ¥ (Valid Period ê´€ë¦¬)
CREATE TABLE analyst_histories (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    person_id UUID REFERENCES persons(id),
    firm_id UUID REFERENCES securities_firms(id),
    sector VARCHAR(100),
    valid_from DATE NOT NULL,
    valid_to DATE,
    created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_analyst_histories_range ON analyst_histories(person_id, valid_from, valid_to);

-- ==========================================
-- 2. ë¦¬í¬íŠ¸ ë° ì›ë³¸ ê´€ë¦¬
-- ==========================================

CREATE TABLE reports (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title TEXT NOT NULL,
    published_at DATE NOT NULL,
    category_code VARCHAR(30) REFERENCES report_categories(code),
    source_url TEXT,
    naver_report_id VARCHAR(50) UNIQUE,
    status processing_status DEFAULT 'collected',
    created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_reports_published_at ON reports(published_at DESC);

CREATE TABLE report_files (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    report_id UUID REFERENCES reports(id),
    file_hash VARCHAR(64) UNIQUE,
    storage_path TEXT,
    raw_text_path TEXT,
    summary_text TEXT,
    extraction_method VARCHAR(20),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE report_analysts (
    report_id UUID REFERENCES reports(id),
    person_id UUID REFERENCES persons(id),
    role VARCHAR(20) DEFAULT 'author',
    PRIMARY KEY (report_id, person_id)
);

-- ==========================================
-- 3. ë¶„ì„ ê²°ê³¼ (ê°€ì¹˜ í•¨ì • íŒë³„ ì¶”ê°€)
-- ==========================================

CREATE TABLE report_opinions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    report_id UUID REFERENCES reports(id),
    asset_id UUID REFERENCES assets_master(id),
    
    -- ëª©í‘œê°€
    target_price FLOAT,
    prev_target_price FLOAT,
    prev_tp_source VARCHAR(20), -- 'db_lookup', 'llm_extracted'
    
    current_stock_price FLOAT,
    opinion_label opinion_type,
    
    -- í€ë”ë©˜í„¸ ìƒíƒœ (New)
    fundamental_status fundamental_status,
    
    -- ê³„ì‚° í•„ë“œ
    tp_change_pct FLOAT GENERATED ALWAYS AS (
        CASE 
            WHEN prev_target_price IS NULL OR prev_target_price = 0 THEN NULL
            ELSE ((target_price - prev_target_price) / prev_target_price) * 100 
        END
    ) STORED,
    
    tp_upside_pct FLOAT GENERATED ALWAYS AS (
        CASE 
            WHEN current_stock_price IS NULL OR current_stock_price = 0 THEN NULL
            ELSE ((target_price - current_stock_price) / current_stock_price) * 100 
        END
    ) STORED,
    
    -- ë‚´ìš©
    key_theses JSONB,
    risk_factors JSONB,
    key_facts JSONB,
    
    -- ë©”íƒ€ë°ì´í„°
    llm_model VARCHAR(50),
    llm_prompt_version VARCHAR(20),
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- ==========================================
-- 4. ì‹œê³„ì—´ ë°ì´í„° (ìˆ˜ì • ì£¼ê°€ ë° ê°ì„±)
-- ==========================================

-- ì£¼ê°€ ì‹œê³„ì—´ (ìˆ˜ì • ì£¼ê°€ ë°˜ì˜)
CREATE TABLE stock_prices (
    asset_id UUID REFERENCES assets_master(id),
    date DATE NOT NULL,
    close_price FLOAT NOT NULL,
    adjustment_factor FLOAT DEFAULT 1.0, -- ì•¡ë©´ë¶„í• /ì¦ì ë³´ì • ê³„ìˆ˜
    volume BIGINT,
    market_cap BIGINT,
    PRIMARY KEY (asset_id, date)
);
CREATE INDEX idx_stock_prices_date ON stock_prices(date DESC);

-- ì¢…ëª©ë³„ ì¼ë³„ ì„¼í‹°ë©˜íŠ¸ ì§‘ê³„ (ëª¨ë©˜í…€/ê³¼ì—´ ì§€í‘œ ì¶”ê°€)
CREATE TABLE asset_sentiment_daily (
    asset_id UUID REFERENCES assets_master(id),
    date DATE NOT NULL,
    
    -- ì˜ê²¬ ë¶„í¬ (Hold=Sell ë¡œì§ ì ìš© ê³„ì‚°)
    bullish_count INTEGER DEFAULT 0,
    neutral_count INTEGER DEFAULT 0,
    bearish_count INTEGER DEFAULT 0,
    
    -- ëª©í‘œê°€ ì§€í‘œ
    avg_target_price FLOAT,
    avg_tp_change_pct FLOAT,
    
    -- ëª¨ë©˜í…€ ë° ê³¼ì—´ ì§€í‘œ (New)
    tp_up_velocity FLOAT,           -- ëª©í‘œê°€ ìƒìŠ¹ ê¸°ìš¸ê¸°
    consecutive_tp_up INTEGER,      -- ì—°ì† ìƒí–¥ íšŸìˆ˜
    consecutive_tp_down INTEGER,    -- ì—°ì† í•˜í–¥ íšŸìˆ˜
    target_price_spread FLOAT,      -- ëª©í‘œê°€ í‘œì¤€í¸ì°¨
    min_upside_pct FLOAT,           -- ìµœì†Œ ìƒìŠ¹ ì—¬ë ¥
    
    sentiment_score FLOAT,          -- (Bullish - Bearish - Neutral*0.5) / Total
    created_at TIMESTAMP DEFAULT NOW(),
    
    PRIMARY KEY (asset_id, date)
);

-- ==========================================
-- 5. ì„ë² ë”© (pgvector)
-- ==========================================

CREATE TABLE report_embeddings (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    report_id UUID REFERENCES reports(id) ON DELETE CASCADE,
    opinion_id UUID REFERENCES report_opinions(id),
    embedding_type VARCHAR(30) NOT NULL, -- 'thesis', 'risk', 'combined'
    embedding vector(1536),
    model_used VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_embeddings_thesis ON report_embeddings USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100) WHERE embedding_type = 'thesis';

-- ==========================================
-- 6. êµ­ë©´ íƒì§€ (Pessimism & Euphoria)
-- ==========================================

-- ë¹„ê´€ êµ­ë©´ (ë§¤ìˆ˜ íƒ€ì´ë°)
CREATE TABLE pessimism_periods (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    asset_id UUID REFERENCES assets_master(id),
    start_date DATE NOT NULL,
    end_date DATE,
    min_sentiment_score FLOAT,
    avg_tp_change_pct FLOAT,
    was_actual_bottom BOOLEAN,
    price_at_start FLOAT,
    price_1y_after FLOAT,
    return_1y FLOAT GENERATED ALWAYS AS (
        CASE WHEN price_at_start > 0 THEN (price_1y_after - price_at_start) / price_at_start * 100 ELSE NULL END
    ) STORED,
    created_at TIMESTAMP DEFAULT NOW()
);

-- í™˜í¬ êµ­ë©´ (ë§¤ë„ íƒ€ì´ë°)
CREATE TABLE euphoria_periods (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    asset_id UUID REFERENCES assets_master(id),
    start_date DATE NOT NULL,
    end_date DATE,
    max_sentiment_score FLOAT,
    min_upside_pct FLOAT,
    was_actual_top BOOLEAN,
    price_at_start FLOAT,
    price_3m_after FLOAT,
    price_drop_3m FLOAT GENERATED ALWAYS AS (
        CASE WHEN price_at_start > 0 THEN (price_3m_after - price_at_start) / price_at_start * 100 ELSE NULL END
    ) STORED,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 4. í•µì‹¬ ë¡œì§ (Core Logic v7)

ë°ì´í„°ì˜ ì •í•©ì„±ì„ ë³´ì¥í•˜ê³  í•œêµ­ ì‹œì¥ íŠ¹ì„±ì„ ë°˜ì˜í•˜ê¸° ìœ„í•œ í•µì‹¬ ì•Œê³ ë¦¬ì¦˜ì…ë‹ˆë‹¤.

### 4.1 ëª©í‘œê°€ ë³´ì • ë¡œì§ (Adjusted Price Logic)
ì•¡ë©´ë¶„í• , ìœ ìƒì¦ì ë“±ìœ¼ë¡œ ì¸í•´ ëª©í‘œê°€ì˜ ì—°ì†ì„±ì´ ê¹¨ì§€ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤. ì´ëŠ” ì‹œìŠ¤í…œì´ ì˜ëª»ëœ "í•˜í–¥ ì¡°ì •" ì‹ í˜¸ë¥¼ ë‚´ëŠ” ê²ƒì„ ë§‰ëŠ” ê°€ì¥ ì¤‘ìš”í•œ ë¡œì§ì…ë‹ˆë‹¤.

```python
def calculate_adjusted_tp_change(
    current_tp: float, 
    prev_tp: float, 
    prev_date: date, 
    asset_id: UUID,
    db_conn
) -> float:
    """
    ëª©í‘œê°€ ë³€í™”ìœ¨ ê³„ì‚° ì‹œ ìˆ˜ì • ì£¼ê°€(Adjustment Factor) ë°˜ì˜
    """
    # 1. ì´ì „ ë¦¬í¬íŠ¸ ì‘ì„± ì‹œì ì˜ ë³´ì • ê³„ìˆ˜ ì¡°íšŒ
    # stock_prices í…Œì´ë¸”ì— dailyë¡œ ì €ì¥ëœ adjustment_factorë¥¼ ì‚¬ìš©
    adj_factor_row = await db_conn.fetchrow("""
        SELECT adjustment_factor 
        FROM stock_prices 
        WHERE asset_id = $1 AND date <= $2 
        ORDER BY date DESC LIMIT 1
    """, asset_id, prev_date)
    
    if not adj_factor_row:
        return 0.0 # ê¸°ì¤€ ì—†ìŒ
        
    adj_factor = adj_factor_row['adjustment_factor']
    
    # 2. ê³¼ê±° ëª©í‘œê°€ë¥¼ í˜„ì¬ ì£¼ê°€ ê¸°ì¤€ìœ¼ë¡œ ë³´ì • (ì—­ë³´ì •)
    # ì˜ˆ: 1:50 ì•¡ë©´ë¶„í•  ì‹œ, ê³¼ê±° ëª©í‘œê°€ 300ë§Œì› -> 6ë§Œì›ìœ¼ë¡œ ë³´ì •
    # ê³„ì‚°ì‹: Adjusted_Prev = Prev_TP / Adj_Factor
    # ì£¼ì˜: DBì— ì €ì¥ëœ factorê°€ ëˆ„ì  ë°°ìˆ˜ë¼ë©´ ë¡œì§ì— ë”°ë¼ ë‚˜ëˆ„ê±°ë‚˜ ê³±í•´ì•¼ í•¨.
    # ì—¬ê¸°ì„œëŠ” "í˜„ì¬ 1ì£¼ê°€ ê³¼ê±° ëª‡ ì£¼ì¸ê°€" ë¹„ìœ¨ì´ë¼ ê°€ì •í•˜ê³  ì—­ì‚°.
    adjusted_prev_tp = prev_tp / adj_factor if adj_factor > 0 else prev_tp
    
    # 3. ë³€í™”ìœ¨ ê³„ì‚°
    if adjusted_prev_tp == 0: return 0.0
    return ((current_tp - adjusted_prev_tp) / adjusted_prev_tp) * 100
```

### 4.2 ê°ì„± ì ìˆ˜ ê³„ì‚° (Korean Market Style)
í•œêµ­ ì‹œì¥ì˜ êµ¬ì¡°ì  íŠ¹ì„±(Hold = Sell)ì„ ë°˜ì˜í•˜ì—¬ ê°ì„± ì ìˆ˜ë¥¼ ì¬ì •ì˜í•©ë‹ˆë‹¤.

```python
def calculate_sentiment_score(bullish: int, neutral: int, bearish: int) -> float:
    """
    í•œêµ­ ì‹œì¥ íŠ¹ì„± ë°˜ì˜: Hold(Neutral)ë¥¼ ì•½í•œ ë§¤ë„(Bearish)ë¡œ ì²˜ë¦¬
    ë¶„ëª¨ëŠ” ì „ì²´ ë¦¬í¬íŠ¸ ìˆ˜, ë¶„ìëŠ” ë§¤ìˆ˜ì„¸ì—ì„œ ë§¤ë„ì„¸ë¥¼ ëº€ ê°’.
    """
    # Holdë¥¼ Bearishì˜ 50% ê°€ì¤‘ì¹˜ë¡œ í¬í•¨ (ì‹œì¥ ê´€í–‰ ë°˜ì˜)
    effective_bearish = bearish + (neutral * 0.5)
    total = bullish + neutral + bearish
    
    if total == 0: return 0.0
    
    # ì ìˆ˜: -100 (ê·¹ë„ì˜ ë¹„ê´€) ~ 100 (ê·¹ë„ì˜ ë‚™ê´€)
    score = ((bullish - effective_bearish) / total) * 100
    return score
```

### 4.3 LLM í”„ë¡¬í”„íŠ¸: ê°€ì¹˜ í•¨ì • íƒì§€ ë° êµì • (Value Trap Detection)

```python
EXTRACTION_PROMPT_TEMPLATE = """
ë‹¹ì‹ ì€ ì¦ê¶Œì‚¬ ë¦¬í¬íŠ¸ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ì‹œì˜¤.

[ì£¼ì˜ì‚¬í•­]
1. í…ìŠ¤íŠ¸ ë‚´ ì˜¤íƒ€ë‚˜ ìŒì„± ì¸ì‹ ì˜¤ë¥˜(ì˜ˆ: 'ì—ì¹˜ë¹„ì— ')ë¥¼ ë¬¸ë§¥ì— ë§ëŠ” ì˜¬ë°”ë¥¸ ìš©ì–´('HBM')ë¡œ êµì •í•˜ì‹œì˜¤.
2. í•œêµ­ ì‹œì¥ ê¸°ì¤€ìœ¼ë¡œ 'ì¤‘ë¦½(Hold)' ì˜ê²¬ì€ ì‚¬ì‹¤ìƒ 'ë§¤ë„'ì˜ë¯¸ì„ì„ ì¸ì§€í•˜ê³  ë¶„ì„í•˜ì‹œì˜¤.

[ë¶„ì„ í•­ëª©]
1. opinion: íˆ¬ìì˜ê²¬ (STRONG_BUY, BUY, HOLD, SELL, STRONG_SELL)
2. target_price: ëª©í‘œì£¼ê°€ (ìˆ«ìë§Œ ì¶”ì¶œ)
3. fundamental_status: 
   - CYCLICAL_DOWNTURN: ì—…í™© ì‚¬ì´í´ ì¼ì‹œ ì¹¨ì²´
   - STRUCTURAL_DECLINE: êµ¬ì¡°ì  ì‡ í‡´ (ì ì ì‹¬í™”, ê²½ìŸë ¥ ìƒì‹¤) -> ì´ ê²½ìš° ë°˜ë“œì‹œ ì´ìœ  ëª…ì‹œ
   - GROWTH: ì„±ì¥ êµ­ë©´
4. key_theses: í•µì‹¬ íˆ¬ì ë…¼ê±° 3ê°€ì§€
5. risk_factors: ë¦¬ìŠ¤í¬ ìš”ì¸

í…ìŠ¤íŠ¸:
{pdf_text}
"""
```

### 4.4 ì• ë„ë¦¬ìŠ¤íŠ¸ ì´ë ¥ ê´€ë¦¬ (Time-Resistant Logic)
ë¦¬í¬íŠ¸ê°€ ë°œí–‰ì¼ ì—­ìˆœìœ¼ë¡œ ìˆ˜ì§‘ë˜ë”ë¼ë„ ì†Œì† ì •ë³´ê°€ ê¼¬ì´ì§€ ì•Šë„ë¡ Valid Period ê¸°ë°˜ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

```python
async def upsert_analyst_history(person_id: UUID, firm_id: UUID, report_date: date):
    async with db.transaction():
        # ë¯¸ë˜ ì´ë ¥ ì¡°íšŒ (ê°€ì¥ ê°€ê¹Œìš´)
        future_h = await db.fetchrow("... WHERE valid_from > $1 ...", report_date)
        # ê³¼ê±° ì´ë ¥ ì¡°íšŒ
        past_h = await db.fetchrow("... WHERE valid_from <= $1 ...", report_date)
        
        # 1. ì´ë¯¸ ê°™ì€ ì†Œì†ì´ë©´ íŒ¨ìŠ¤
        if past_h and past_h['firm_id'] == firm_id: return
        
        # 2. ë¯¸ë˜ ì´ë ¥ê³¼ ê°™ì€ íšŒì‚¬ë©´ ê¸°ê°„ ì—°ì¥ (valid_from ê³¼ê±°ë¡œ ë‹¹ê¹€)
        if future_h and future_h['firm_id'] == firm_id:
            await db.execute("UPDATE ... SET valid_from = $1", report_date)
            return
            
        # 3. ì‹ ê·œ ì´ë ¥ ìƒì„± (valid_toëŠ” ë‹¤ìŒ ì´ë ¥ í•˜ë£¨ ì „ìœ¼ë¡œ ì„¤ì •)
        valid_to = (future_h['valid_from'] - timedelta(days=1)) if future_h else None
        await db.execute("INSERT ... VALUES (...)", ...)
```

---

## 5. ë”¥ ë¦¬ì„œì¹˜ ì—”ì§„ (Deep Research Engine v7)

ì‹œì¥ì˜ ì‚¬ì´í´(ë¹„ê´€/ê³¼ì—´/ëª¨ë©˜í…€)ì„ íŒë³„í•˜ê³  ëŒ€ì‘ ì „ëµì„ ì œì‹œí•˜ëŠ” ì—”ì§„ì…ë‹ˆë‹¤.

### 5.1 êµ­ë©´ íƒì§€ ë¡œì§ (Regime Detector)

```python
async def detect_market_regimes(asset_id: UUID):
    recent_data = await db.fetch("""
        SELECT sentiment_score, min_upside_pct, consecutive_tp_down, tp_up_velocity
        FROM asset_sentiment_daily
        WHERE asset_id = $1 ORDER BY date DESC LIMIT 30
    """, asset_id)
    
    if not recent_data: return
    
    latest = recent_data[0]
    
    # 1. í™˜í¬ êµ­ë©´ (Euphoria) - ë§¤ë„ íƒ€ì´ë°
    # ì¡°ê±´: ì„¼í‹°ë©˜íŠ¸ ê³¼ì—´(90 ì´ìƒ) + ìƒìŠ¹ ì—¬ë ¥ ì†Œì§„(5% ë¯¸ë§Œ)
    if latest['sentiment_score'] > 90 and latest['min_upside_pct'] < 5:
        await db.execute("INSERT INTO euphoria_periods ...")
        return "EUPHORIA_DETECTED"
        
    # 2. ë¹„ê´€ êµ­ë©´ (Pessimism) - ë§¤ìˆ˜ íƒ€ì´ë°
    # ì¡°ê±´: ì„¼í‹°ë©˜íŠ¸ ë¹™í•˜ê¸°(-50 ì´í•˜) + ì—°ì† ëª©í‘œê°€ í•˜í–¥(3íšŒ ì´ìƒ)
    if latest['sentiment_score'] < -50 and latest['consecutive_tp_down'] >= 3:
        await db.execute("INSERT INTO pessimism_periods ...")
        return "PESSIMISM_DETECTED"
        
    # 3. ëª¨ë©˜í…€ ê°€ì† (Momentum) - ì¶”ì„¸ ì¶”ì¢…
    # ì¡°ê±´: ëª©í‘œê°€ ìƒí–¥ ì†ë„(Velocity) ê¸‰ì¦
    if latest['tp_up_velocity'] > 5.0: # ê¸°ìš¸ê¸° ì„ê³„ê°’
        return "MOMENTUM_ACCELERATING"
```

### 5.2 íŒ¨í„´ ë§¤ì¹­ ë° ì¸ì‚¬ì´íŠ¸ ìƒì„± (Pattern Matching)

```python
async def generate_deep_insight(asset_id: UUID):
    # 1. í˜„ì¬ ìƒí™© ì¤€ë¹„
    current_context = await get_current_context(asset_id)
    current_embedding = await create_embedding(current_context['theses'])
    
    # 2. pgvector ê²€ìƒ‰: ê³¼ê±° ì‹¤ì œ ì €ì ì´ì—ˆë˜ ìœ ì‚¬ ì‚¬ë¡€ ì°¾ê¸°
    # í…ìŠ¤íŠ¸ ì˜ë¯¸ê°€ ìœ ì‚¬í•˜ê³ , ì‹¤ì œë¡œ was_actual_bottom=Trueì¸ ê³¼ê±° ë°ì´í„° ê²€ìƒ‰
    similar_cases = await db.fetch("""
        SELECT r.published_at, ro.key_theses, p.return_1y
        FROM report_embeddings re
        JOIN report_opinions ro ON ro.id = re.opinion_id
        JOIN pessimism_periods p ON p.asset_id = ro.asset_id
        WHERE ro.asset_id = $1 
          AND p.was_actual_bottom IS TRUE
          AND 1 - (re.embedding <=> $2) > 0.75
        ORDER BY similarity DESC LIMIT 10
    """, asset_id, current_embedding)
    
    # 3. Claude Sonnet ì¶”ë¡  ìš”ì²­
    prompt = f"""
    í˜„ì¬ ìƒí™©: {current_context}
    ê³¼ê±° ìœ ì‚¬ ì €ì  ì‚¬ë¡€: {similar_cases}
    
    ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ:
    1. í˜„ì¬ ë¹„ê´€ êµ­ë©´ì´ ê³¼ê±° ì‹¤ì œ ì €ì ê³¼ ì–´ë–¤ ì ì´ ìœ ì‚¬/ìƒì´í•œì§€ ë¶„ì„í•˜ë¼.
    2. í€ë”ë©˜í„¸ ìƒíƒœê°€ STRUCTURAL_DECLINE(ê°€ì¹˜ í•¨ì •)ì´ ì•„ë‹Œì§€ í™•ì¸í•˜ë¼.
    3. ë§¤ìˆ˜ íƒ€ì´ë°ìœ¼ë¡œì„œì˜ ì í•©ì„±ì„ 0~100ì ìœ¼ë¡œ í‰ê°€í•˜ë¼.
    """
    
    return await claude_client.messages.create(...)
```

## 6. LLM ì „ëµ (Model Routing)

ë¹„ìš© íš¨ìœ¨ì„±ê³¼ ë¶„ì„ í’ˆì§ˆì˜ ê· í˜•ì„ ë§ì¶”ê¸° ìœ„í•´ ì‘ì—… ìœ í˜•ì— ë”°ë¼ ìµœì ì˜ ëª¨ë¸ì„ ì„ íƒí•©ë‹ˆë‹¤.

### 6.1 ëª¨ë¸ ì—­í•  ë¶„ë¦¬

| ì‘ì—… ìœ í˜• | ëª¨ë¸ | ì´ìœ  |
| :--- | :--- | :--- |
| **êµ¬ì¡°í™” ì¶”ì¶œ** | **Gemini 2.0 Flash** | ëŒ€ëŸ‰ ì²˜ë¦¬, ì €ë¹„ìš©, ë¹ ë¥¸ ì†ë„. OCR/ì˜¤íƒ€ êµì •ê³¼ êµ¬ì¡°í™” ë™ì‹œ ìˆ˜í–‰ì— ìµœì . |
| **ì‹¬ì¸µ ë¶„ì„** | **Claude 3.7 Sonnet** | ë³µì¡í•œ ì¶”ë¡ (Extended Thinking). íŒ¨í„´ ë¹„êµ, ì „ëµ ìˆ˜ë¦½, ë‰˜ì•™ìŠ¤ íŒŒì•…ì— ê°•ì . |
| **ì„ë² ë”© ìƒì„±** | **text-embedding-3-small** | ì ì ˆí•œ ì°¨ì› ìˆ˜(1536)ì™€ ì„±ëŠ¥, ê°€ì„±ë¹„ ê· í˜•. |
| **ë¡œì»¬ ì²˜ë¦¬** | **BGE-M3 (Ollama)** | í”„ë¼ì´ë²„ì‹œê°€ í•„ìš”í•˜ê±°ë‚˜ API ë¹„ìš©ì„ ì•„ë‚„ ë•Œ ì‚¬ìš© (Mac Local). |

### 6.2 ë¼ìš°íŒ… íŒŒì´í”„ë¼ì¸ êµ¬í˜„

```python
from anthropic import Anthropic
import google.generativeai as genai
from openai import OpenAI

class LLMRouter:
    def __init__(self):
        self.gemini = genai.GenerativeModel("gemini-2.0-flash")
        self.claude = Anthropic()
        self.openai = OpenAI()

    async def extract_structured(self, text: str) -> dict:
        """
        [Gemini Flash] ì´ˆì €ë¹„ìš© êµ¬ì¡°í™” ì¶”ì¶œ
        - ì˜¤íƒ€ êµì •, Value Trap ë¶„ë¥˜, Target Price ì¶”ì¶œ ë™ì‹œ ìˆ˜í–‰
        """
        response = await self.gemini.generate_content_async(
            contents=f"{EXTRACTION_PROMPT_TEMPLATE}\n\n{text}",
            generation_config={"response_mime_type": "application/json"}
        )
        return response.text

    async def create_embedding(self, text: str) -> list[float]:
        """
        [text-embedding-3-small] ë²¡í„°í™”
        """
        response = await self.openai.embeddings.create(
            model="text-embedding-3-small",
            input=text
        )
        return response.data[0].embedding

    async def deep_analysis(self, context: dict, cases: list) -> str:
        """
        [Claude Sonnet] Extended Thinking ë”¥ ë¦¬ì„œì¹˜
        """
        prompt = f"""
        í˜„ì¬ ìƒí™©: {context}
        ìœ ì‚¬ ê³¼ê±° ì‚¬ë¡€: {cases}
        
        ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í˜„ì¬ ì‹œì ì´ 'ë¹„ê´€ì˜ ë'ì¸ì§€, ì•„ë‹ˆë©´ 'ê°€ì¹˜ í•¨ì •'ì¸ì§€ ì‹¬ì¸µ ë¶„ì„í•˜ë¼.
        ë„ˆì˜ ì¶”ë¡  ê³¼ì •(Thinking)ì„ í¬í•¨í•˜ì—¬ ë‹µë³€í•˜ë¼.
        """
        
        response = await self.claude.messages.create(
            model="claude-3-7-sonnet-20250219",
            max_tokens=16000,
            thinking={"type": "enabled", "budget_tokens": 8000},
            messages=[{"role": "user", "content": prompt}]
        )
        return response.content
```

---

## 7. ìš´ì˜ ë° ë°°ì¹˜ ì‘ì—… (Operations)

ê°œì¸ìš© ë¡œì»¬ í™˜ê²½(Mac)ì„ ê¸°ì¤€ìœ¼ë¡œ íš¨ìœ¨ì ì¸ ìš´ì˜ ë°©ì•ˆì„ ì •ì˜í•©ë‹ˆë‹¤.

### 7.1 ë°°ì¹˜ ìŠ¤ì¼€ì¤„ëŸ¬ (Idempotent & Robust)
ì¤‘ë‹¨ë˜ì–´ë„ ì¬ì‹¤í–‰ ì‹œ ì‹¤íŒ¨ ì§€ì ë¶€í„° ì´ì–´ì„œ ì‘ì—…í•˜ë„ë¡ ì„¤ê³„í•©ë‹ˆë‹¤.

```python
import asyncio
import random
import os

async def daily_batch_job():
    print("=== ë°°ì¹˜ ì‘ì—… ì‹œì‘ ===")
    
    # 1. ë¯¸ì™„ë£Œ ì‘ì—… ì¡°íšŒ (Resume Capability)
    pending_reports = await db.fetch(
        "SELECT * FROM reports WHERE status NOT IN ('completed', 'skipped') ORDER BY published_at DESC"
    )
    
    for report in pending_reports:
        try:
            # 2. Rate Limit ëŒ€ì‘ (Jitter)
            # ë„¤ì´ë²„/ì¦ê¶Œì‚¬ í¬ë¡¤ë§ ì°¨ë‹¨ ë°©ì§€ë¥¼ ìœ„í•œ ë¶ˆê·œì¹™ ëŒ€ê¸°
            await asyncio.sleep(random.uniform(2.0, 5.0))
            
            # 3. ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
            # PDF ë‹¤ìš´ë¡œë“œ -> í…ìŠ¤íŠ¸ ì¶”ì¶œ -> LLM ë¶„ì„ -> DB ì €ì¥
            await process_report_pipeline(report)
            
        except Exception as e:
            print(f"Error processing {report.id}: {e}")
            await db.execute(
                "UPDATE reports SET status = 'failed_llm', error_msg = $1 WHERE id = $2",
                str(e), report.id
            )
            
        finally:
            # 4. ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (Disk Space Management)
            # ì²˜ë¦¬ê°€ ëë‚œ ì„ì‹œ PDF/ì˜¤ë””ì˜¤ íŒŒì¼ ì¦‰ì‹œ ì‚­ì œ
            if os.path.exists(report.temp_path):
                os.remove(report.temp_path)
                
    print("=== ë°°ì¹˜ ì‘ì—… ì¢…ë£Œ ===")
```

### 7.2 ë°œì—´ ê´€ë¦¬ (Thermal Management)
M-series Macì˜ ì§€ì†ì  ë¶€í•˜ë¡œ ì¸í•œ ë°œì—´/íŒ¬ ì†ŒìŒì„ ì¤„ì´ê¸° ìœ„í•´ ì‘ì—…ì„ ë¶„ë¦¬í•©ë‹ˆë‹¤.

-   **Phase 1 (ì €ë… 7~9ì‹œ)**: **Network/I/O Bound**. ë¦¬í¬íŠ¸ ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘, PDF ë‹¤ìš´ë¡œë“œ.
-   **Phase 2 (ì €ë… 9~11ì‹œ)**: **API Bound**. Gemini/Claude API í˜¸ì¶œ (ëŒ€ê¸° ì‹œê°„ å¤š).
-   **Phase 3 (ì‹¬ì•¼ 11ì‹œ~)**: **Compute Bound**. ë¡œì»¬ ì„ë² ë”©(BGE-M3) ìƒì„±, OCR ì²˜ë¦¬.

### 7.3 ì´ˆê¸° ë°ì´í„° ë°±í•„ (Backfill Strategy)
ê³¼ê±° ë°ì´í„°(5ë…„/10ë…„ ì¹˜) ì ì¬ ì‹œ ë°œìƒí•˜ëŠ” ë¹„ìš©ê³¼ ì‹œê°„ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

1.  **Tracking Targets ì„¤ì •**: `tracking_targets` í…Œì´ë¸”ì— ì¢…ëª©/ì„¹í„°ë³„ ìˆ˜ì§‘ ê¸°ê°„ ì„¤ì •.
2.  **ì ì§„ì  ìˆ˜ì§‘**: í•œ ë²ˆì— ê¸ì§€ ì•Šê³ , `sleep`ì„ ê¸¸ê²Œ ì£¼ì–´ IP ì°¨ë‹¨ ë°©ì§€.
3.  **ë¹„ìš© ê´€ë¦¬**: Gemini FlashëŠ” ì €ë ´í•˜ì§€ë§Œ(ì•½ $0.1/1M tokens), ìˆ˜ë§Œ ê±´ ì²˜ë¦¬ ì‹œ ë¹„ìš© ë°œìƒ. 1ì¼ ì²˜ë¦¬ í•œë„ ì„¤ì • (ì˜ˆ: 1ì¼ 500ê±´).

---

## 8. ìœ ì¦ˆì¼€ì´ìŠ¤ (Use Cases)

### Case 1. ê°€ì¹˜ í•¨ì • íšŒí”¼ (Value Trap Avoidance)
-   **ìƒí™©**: ì„¬ìœ  ê¸°ì—… Aê°€ ì €PER/ì €PBRë¡œ 'ì €í‰ê°€'ë˜ì–´ ë³´ì´ê³ , ë¦¬í¬íŠ¸ ì˜ê²¬ë„ 'Buy'ì„.
-   **ì‹œìŠ¤í…œ ë™ì‘**:
    1. LLMì´ ë¦¬í¬íŠ¸ ë³¸ë¬¸ ë¶„ì„ ì¤‘ "ì ì ëˆ„ì ", "ì¤‘êµ­ ì €ê°€ ê³µì„¸", "ì‹œì¥ ì ìœ ìœ¨ í•˜ë½" ê°ì§€.
    2. `fundamental_status`ë¥¼ `STRUCTURAL_DECLINE`ìœ¼ë¡œ íŒë³„.
    3. ì„¼í‹°ë©˜íŠ¸ ì ìˆ˜ê°€ ë‚®ì•„ë„ "ë¹„ê´€ì˜ ë" í›„ë³´ì—ì„œ ìë™ ì œì™¸.
-   **ì¸ì‚¬ì´íŠ¸**: "ë‹¨ìˆœ ì €í‰ê°€ê°€ ì•„ë‹Œ êµ¬ì¡°ì  ë„íƒœ ìœ„í—˜. ë§¤ìˆ˜ ê¸ˆì§€."

### Case 2. ê³¼ì—´ ê²½ë³´ ë° ë§¤ë„ íƒ€ì´ë° (Euphoria Detection)
-   **ìƒí™©**: AI ë°˜ë„ì²´ ê¸°ì—… Bì˜ ì£¼ê°€ê°€ ê¸‰ë“±. ëª¨ë“  ì• ë„ë¦¬ìŠ¤íŠ¸ê°€ 'Strong Buy'.
-   **ì‹œìŠ¤í…œ ë™ì‘**:
    1. `sentiment_score` 95ì  ë„ë‹¬ (ê·¹ë„ì˜ ë‚™ê´€).
    2. `min_upside_pct`ê°€ 2%ë¡œ í•˜ë½ (ëª©í‘œê°€ ìƒìŠ¹ ì—¬ë ¥ ì†Œì§„).
    3. ì‹œìŠ¤í…œì´ `Euphoria Period`ë¡œ ë§ˆí‚¹ í›„ ì•Œë¦¼ ë°œì†¡.
-   **ì¸ì‚¬ì´íŠ¸**: "ê¸°ëŒ€ì¹˜ê°€ í¬í™” ìƒíƒœ. ë” ì´ìƒì˜ í˜¸ì¬ ì—†ìŒ. ë¶„í•  ë§¤ë„ ì‹œì ."

### Case 3. ìˆ¨ì€ ì§„ì£¼ ë°œêµ´ (Divergence Detection)
-   **ìƒí™©**: ì¤‘ì†Œí˜•ì£¼ Cì˜ ì£¼ê°€ëŠ” íš¡ë³´ ì¤‘ì¸ë°, ë¦¬í¬íŠ¸ì˜ ëª©í‘œê°€ë§Œ ì§€ì†ì ìœ¼ë¡œ ìƒí–¥ ì¡°ì •ë¨.
-   **ì‹œìŠ¤í…œ ë™ì‘**:
    1. `stock_prices` ì¶”ì„¸(Flat) vs `tp_up_velocity`(Rising) ë‹¤ì´ë²„ì „ìŠ¤ ê°ì§€.
    2. "ì‹œì¥ì´ ì•„ì§ ëª¨ë¥´ëŠ” í˜¸ì¬" ê°€ëŠ¥ì„± ì œê¸°.
-   **ì¸ì‚¬ì´íŠ¸**: "í€ë”ë©˜í„¸ ê°œì„  ì†ë„ > ì£¼ê°€ ìƒìŠ¹ ì†ë„. ë¯¸ë°˜ì˜ëœ ìƒìŠ¹ ì—¬ë ¥ ì¡´ì¬."

---

## 9. ê²°ë¡  (Conclusion)

ë³¸ ì„¤ê³„ì„œ(Final Ultimate Version)ëŠ” ë‹¨ìˆœí•œ í…ìŠ¤íŠ¸ ë¶„ì„ ì‹œìŠ¤í…œì„ ë„˜ì–´, **ì‹œì¥ì˜ ì‹¬ë¦¬(Cycle)ì™€ ë°ì´í„°ì˜ ì§„ìœ„(True/False)ë¥¼ ë™ì‹œì— íŒŒì•…í•˜ëŠ” ì‹¤ì „ íˆ¬ì í”Œë«í¼**ì„ ì •ì˜í•©ë‹ˆë‹¤.

### 9.1 í•µì‹¬ ê²½ìŸë ¥
1.  **ì‹ í˜¸ì˜ ì •ì œ**: Hold=Sell, ëª©í‘œê°€ ë³´ì •, ê°€ì¹˜ í•¨ì • ë¶„ë¥˜ë¥¼ í†µí•´ ë°ì´í„°ì˜ ë…¸ì´ì¦ˆë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤.
2.  **ì „ëµì˜ ì™„ê²°ì„±**: ì €ì  ë§¤ìˆ˜(Contrarian)ì™€ ê³ ì  ë§¤ë„(Euphoria), ì¶”ì„¸ ì¶”ì¢…(Momentum)ì„ ëª¨ë‘ ì»¤ë²„í•©ë‹ˆë‹¤.
3.  **í˜„ì‹¤ì  ìš´ì˜**: ë¡œì»¬ ë§¥ë¶ í™˜ê²½ì„ ê³ ë ¤í•œ ë°°ì¹˜ ì„¤ê³„ì™€ ë¹„ìš© íš¨ìœ¨ì ì¸ LLM ë¼ìš°íŒ…ì„ í†µí•´ ê°œì¸ì´ ìš´ì˜ ê°€ëŠ¥í•œ ìˆ˜ì¤€ìœ¼ë¡œ ìµœì í™”í–ˆìŠµë‹ˆë‹¤.

### 9.2 ê¸°ëŒ€ íš¨ê³¼
ì´ ì‹œìŠ¤í…œì€ íˆ¬ììì—ê²Œ **"ì§€ê¸ˆì´ ì‚¬ì´í´ì˜ ì–´ë””ì¸ê°€?"**ë¥¼ ê°ê´€ì ì¸ ë°ì´í„°ë¡œ ì•Œë ¤ì£¼ë©°, ì •ë³´ì˜ í™ìˆ˜ ì†ì—ì„œ ì§„ì •í•œ íˆ¬ì ê¸°íšŒì™€ ìœ„í—˜ ì‹ í˜¸ë¥¼ í¬ì°©í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.